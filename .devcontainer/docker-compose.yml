services:
  dev:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: bladeai-dev
    stdin_open: true
    tty: true
    volumes:
      # Workspace (all 13 repos, bind-mounted from host)
      - ${WORKSPACE:-~/workspace}:/workspace:cached
      # SSH agent forwarding (Linux host)
      - ${SSH_AUTH_SOCK:-/dev/null}:/tmp/ssh-agent.sock
      # SSH config (host aliases, known_hosts) — read-only
      - ~/.ssh/config:/home/vscode/.ssh/config:ro
      - ~/.ssh/known_hosts:/home/vscode/.ssh/known_hosts:ro
      # GitHub CLI auth
      - ~/.config/gh:/home/vscode/.config/gh
      # gcloud auth
      - ~/.config/gcloud:/home/vscode/.config/gcloud
      # Git config: NOT mounted — set up in post-create.sh instead
      # Host gitconfig has core.hooksPath which conflicts with pre-commit install
      - ~/.gitconfig:/home/vscode/.gitconfig-host:ro
      # Persistent named volumes (survive container rebuilds)
      - bladeai-venv:/workspace/.venv
      - bladeai-history:/commandhistory
      - bladeai-uv-cache:/home/vscode/.cache/uv
      - bladeai-claude:/home/vscode/.claude
    environment:
      HOST_UID: "${HOST_UID:-1000}"
      HOST_GID: "${HOST_GID:-1000}"
      SSH_AUTH_SOCK: /tmp/ssh-agent.sock
      HISTFILE: /commandhistory/.bash_history
      PROMPT_COMMAND: "history -a"
      PYTHONDONTWRITEBYTECODE: "1"
      PIP_DISABLE_PIP_VERSION_CHECK: "1"
      UV_CACHE_DIR: /home/vscode/.cache/uv
      PLAYWRIGHT_BROWSERS_PATH: /home/vscode/.cache/ms-playwright
      GH_TOKEN: "${GH_TOKEN}"
    working_dir: /workspace

  git-sync:
    image: alpine/git:latest
    container_name: bladeai-git-sync
    restart: unless-stopped
    volumes:
      - ${WORKSPACE:-~/workspace}:/workspace
      - ~/.config/gh:/root/.config/gh:ro
    environment:
      GH_TOKEN: "${GH_TOKEN}"
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        apk add --no-cache curl openssh-client bash util-linux > /dev/null 2>&1
        git config --global --add safe.directory '*'
        git config --global credential.https://github.com.helper '!/usr/local/bin/gh auth git-credential'
        git config --global credential.https://gist.github.com.helper '!/usr/local/bin/gh auth git-credential'
        # Install gh CLI for HTTPS credential helper
        curl -sL "https://github.com/cli/cli/releases/download/v2.86.0/gh_2.86.0_linux_amd64.tar.gz" \
          | tar xz -C /tmp && cp /tmp/gh_2.86.0_linux_amd64/bin/gh /usr/local/bin/
        # Verify gh auth before first sync (use gh auth token — gh auth status
        # exits non-zero when hosts.yml has a stale entry even if GH_TOKEN works)
        if gh auth token >/dev/null 2>&1; then
          echo "[git-sync] gh auth: OK"
        else
          echo "[git-sync] WARNING: gh auth failed — syncs may fail"
        fi
        echo "[git-sync] Started. Syncing every 5 minutes."
        while true; do
          bash /workspace/dev-env/sync/git-sync.sh 2>&1
          sleep 300
        done

volumes:
  bladeai-venv:
  bladeai-history:
  bladeai-uv-cache:
  bladeai-claude:
