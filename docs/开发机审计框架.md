# BladeAI 开发机审计框架 v1.0

> **创建**: 2026-02-17 (Claude 设计)
> **适用对象**: 4 台开发机的一致性审计
> **关联文档**: `审计框架.md` (生产 VPS 审计), `BladeAI_架构文档_v4.9.md`

---

## 一、框架概述

### 1.1 目的

4 台开发机应保持一致的开发环境，使得在任一台机器上都能：
- 编辑、提交、推送所有 12 个仓库
- SSH 到全部 BladeAI 生产 VPS
- 使用 gcloud 管理 GCP 资源
- 运行 AI/量化相关 Python 项目

### 1.2 四台机器

| 代号 | SSH 连接 | 用户 | OS | 角色 |
|------|---------|------|-----|------|
| **iMac** | localhost | kaileizhang | macOS | 主力开发机 (上海) |
| **MacBook Pro** | `ssh macbook` (192.168.50.175) | simba | macOS | 便携开发机 (上海) |
| **Mac Mini** | `ssh mac-mini` (100.77.47.23) | ob | macOS | 美国住宅 IP 节点 + 远程开发 |
| **Tokyo VM** | `ssh dev-vm-tokyo` (100.67.53.22) | simba | Ubuntu 24.04 | 东京 GCP 开发 VM |

> **注意**: Mac Mini 用户是 `ob`，不是 `simba`。Tokyo VM 是 Linux，其余三台是 macOS。

### 1.3 审计原则

| 原则 | 说明 |
|------|------|
| **一致性优先** | 4 台机器的检查项结果应一致，除非有标注的"已知差异" |
| **幂等采集** | 同一命令在同一台机器上两次运行结果应相同（排除状态类） |
| **分层检查** | 配置类 = 必须一致；状态类 = 仅记录；版本类 = 允许小版本差异 |
| **已知豁免** | 某些差异是刻意的，标记为 KNOWN，不计入 FAIL |

### 1.4 结果分类

| 分类 | 含义 |
|------|------|
| ✅ **PASS** | 一致且符合预期 |
| ❌ **FAIL** | 不一致或缺失，需修复 |
| ⚠️ **WARN** | 部分偏差但可接受 |
| 📌 **KNOWN** | 已知差异，刻意保留 |
| ⏭️ **N/A** | 不适用于该机器 |

---

## 二、审计维度

框架分为 **8 个维度**，每个维度包含具体检查项。

### 维度总览

```
┌──────────────────────────────────────────────────┐
│  D1. 基础工具链     — 开发工具版本一致性             │
│  D2. GitHub 认证    — gh CLI + SSH key             │
│  D3. gcloud 认证    — GCP 项目与账户               │
│  D4. VPS SSH 访问   — 能否连到全部生产服务器         │
│  D5. 仓库同步       — 12 个 repo 存在性与同步状态    │
│  D6. 自动同步基建   — git-sync daemon 运行状态      │
│  D7. 安全基线       — pre-commit hooks, 密钥管理    │
│  D8. Python 环境    — workspace venv 一致性         │
└──────────────────────────────────────────────────┘
```

---

## 三、检查清单

### D1. 基础工具链

检查所有开发工具是否安装且版本一致。

| # | 检查项 | 采集命令 | 预期 | 级别 |
|---|--------|---------|------|------|
| D1.01 | Python 版本 | `python3 --version` | 3.12.x | 必须 |
| D1.02 | pyenv 安装 | `pyenv --version` | 存在 | 必须 (macOS) / N/A (Linux) |
| D1.03 | Node.js 版本 | `node --version` | 存在即可 | 建议 |
| D1.04 | Git 版本 | `git --version` | >= 2.39 | 必须 |
| D1.05 | gh CLI 版本 | `gh --version` | >= 2.60 | 必须 |
| D1.06 | uv 版本 | `uv --version` | 存在 | 必须 |
| D1.07 | gitleaks 版本 | `gitleaks version` | 存在 | 必须 |
| D1.08 | Docker | `docker --version` | 存在即可 | 建议 |
| D1.09 | Claude Code | `claude --version` | 存在即可 | 建议 |
| D1.10 | Homebrew (macOS) | `brew --version` | 存在 | 必须 (macOS) |

**版本一致性判定**:
- 主版本 + 次版本必须一致 (如 Python 3.12.x)
- 补丁版本允许差异 (3.12.3 vs 3.12.12 = WARN，不是 FAIL)
- 工具存在性比版本精确匹配更重要

### D2. GitHub 认证

| # | 检查项 | 采集命令 | 预期 | 级别 |
|---|--------|---------|------|------|
| D2.01 | gh auth 状态 | `gh auth status` | Logged in | 必须 |
| D2.02 | gh auth scopes | `gh auth status` 输出 | 含 `repo`, `read:org` | 必须 |
| D2.03 | SSH key 到 GitHub | `ssh -T git@github.com 2>&1` | "successfully authenticated" | 必须 |
| D2.04 | git credential helper | `git config --global credential.helper` | 有效配置 | 建议 |

**判定规则**:
- D2.01 FAIL + D2.03 PASS = 可用 SSH URL 操作，WARN 级别
- D2.01 FAIL + D2.03 FAIL = 无法 push/pull，FAIL 级别
- 修复: `gh auth login` 或从已认证机器 pipe token

### D3. gcloud 认证

| # | 检查项 | 采集命令 | 预期 | 级别 |
|---|--------|---------|------|------|
| D3.01 | gcloud 安装 | `gcloud --version` | 存在 | 建议 |
| D3.02 | 活跃账户 | `gcloud auth list 2>/dev/null \| grep ACTIVE` | 有 ACTIVE 账户 | 建议 |
| D3.03 | 项目 ID | `gcloud config get project` | `obiwanfly` | 建议 |

**已知豁免**:
- Mac Mini 不需要 gcloud (📌 KNOWN) — 该机器主要作为住宅 IP 代理节点，不管理 GCP

### D4. VPS SSH 访问

从每台开发机测试 SSH 到全部生产 VPS。

| # | 检查项 | 采集命令 | 预期 | 级别 |
|---|--------|---------|------|------|
| D4.01 | SSH → hk-panel | `ssh -o ConnectTimeout=10 hk-panel echo ok` | ok | 必须 |
| D4.02 | SSH → jp-dmit | `ssh -o ConnectTimeout=10 jp-dmit echo ok` | ok | 必须 |
| D4.03 | SSH → sg-proxy | `ssh -o ConnectTimeout=10 sg-proxy echo ok` | ok | 必须 |
| D4.04 | SSH → us-dmit | `ssh -o ConnectTimeout=10 us-dmit echo ok` | ok | 必须 |
| D4.05 | SSH → us-gateway | `ssh -o ConnectTimeout=10 us-gateway echo ok` | ok | 建议 |
| D4.06 | SSH config 完整性 | `grep -c '^Host ' ~/.ssh/config` | >= 5 个 VPS 别名 | 必须 |

**前置条件**:
- Tailscale 在线 (对 hk-panel, sg-proxy, us-gateway 等 100.x.x.x 地址)
- SSH key 在 VPS authorized_keys 中

**MacBook Pro 特殊注意**:
- 使用 1Password SSH Agent，`Host *` 必须在 config 末尾
- 每个 VPS host 必须有 `IdentityAgent none` 指令
- 验证: 在非 GUI 远程 SSH 会话中也能连接 VPS

**已知豁免**:
- Mac Mini 可能无完整 VPS SSH config (📌 KNOWN) — 远程开发用，主要通过其他机器跳转管理

### D5. 仓库同步

12 个仓库必须全部存在于 `~/workspace/` 下。

**仓库列表**:
```
bladeai          clawforce         crypto-backtest
quant-backtest   quant-lab         ntws
longxia-market   ig-recruit-radar  xai-radar
claude-memory    ai-expert-monitor whisper-vocab
```

| # | 检查项 | 采集命令 | 预期 | 级别 |
|---|--------|---------|------|------|
| D5.01 | 仓库数量 | `ls -d ~/workspace/*/.git \| wc -l` | 12 | 必须 |
| D5.02 | 仓库完整性 | 逐一检查 12 个目录存在 | 全部存在 | 必须 |
| D5.03 | 分支状态 | `git -C <repo> branch --show-current` | main (大部分) | 记录 |
| D5.04 | 远程同步 | `git -C <repo> fetch; git rev-list HEAD..origin/main --count` | 0 (已同步) | 建议 |
| D5.05 | 脏状态 | `git -C <repo> status --porcelain` | 记录（不要求 clean） | 记录 |

**判定规则**:
- 缺少仓库 = FAIL (需 clone)
- behind remote > 0 = WARN (可能 git-sync 未生效)
- dirty = 仅记录，不判定（正常开发活动）
- `clawforce` 仓库属于 `heydoraai` org，不是 `yagjzx`

### D6. 自动同步基建 (git-sync)

| # | 检查项 | 采集命令 | 预期 | 级别 |
|---|--------|---------|------|------|
| D6.01 | git-sync.sh 存在 | `ls ~/workspace/.sync/git-sync.sh` | 存在 | 必须 |
| D6.02 | REPOS 数量 | `grep -c 'REPOS=' ~/workspace/.sync/git-sync.sh` + 检查数组长度 | 12 个 repo | 必须 |
| D6.03 | 无硬编码密钥 | `grep -E '(TG_BOT_TOKEN|TG_CHAT_ID)=' ~/workspace/.sync/git-sync.sh \| grep -v grep \| grep -v '\$'` | 无硬编码值 | 必须 |
| D6.04 | launchd/cron 运行 | macOS: `launchctl list \| grep git-sync`; Linux: `crontab -l \| grep git-sync` | 存在且运行 | 必须 |
| D6.05 | 最近运行 | `tail -5 ~/workspace/.sync/sync.log` | 最近 10 分钟内有日志 | 建议 |

**判定规则**:
- REPOS 数组少于 12 = FAIL (新 repo 未加入)
- 硬编码 TG_BOT_TOKEN = FAIL (安全风险)
- launchd 未运行 = FAIL (同步失效)
- sync.log 超过 1 小时无更新 = WARN

### D7. 安全基线

| # | 检查项 | 采集命令 | 预期 | 级别 |
|---|--------|---------|------|------|
| D7.01 | pre-commit hook 存在 | `ls ~/workspace/.githooks/pre-commit` | 存在 | 必须 |
| D7.02 | hooksPath 配置 | `git config --global core.hooksPath` | `~/workspace/.githooks` 或绝对路径 | 必须 |
| D7.03 | gitleaks 可用 | `which gitleaks` | 有输出 | 必须 |
| D7.04 | .zshrc 无硬编码密钥 | `grep -E '(API_KEY|TOKEN|SECRET)=' ~/.zshrc \| grep -v source \| grep -v '\$('` | 无硬编码 | 必须 |
| D7.05 | SSH key 存在 | `ls ~/.ssh/id_ed25519` | 存在 | 必须 |
| D7.06 | SSH key 权限 | `stat -f '%A' ~/.ssh/id_ed25519` (macOS) 或 `stat -c '%a'` (Linux) | 600 | 必须 |
| D7.07 | hook 使用 gitleaks | `head -5 ~/workspace/.githooks/pre-commit \| grep gitleaks` | 包含 gitleaks | 必须 |

**判定规则**:
- pre-commit hook 或 hooksPath 缺失 = FAIL (可能泄露密钥)
- .zshrc 含明文 API Key = FAIL (应迁移到 ~/.env.keys 并 source)
- hook 应使用 gitleaks 二进制 (而非仅 regex 匹配), 确保全局 hooksPath 覆盖所有 repo

### D8. Python 环境

| # | 检查项 | 采集命令 | 预期 | 级别 |
|---|--------|---------|------|------|
| D8.01 | workspace .venv 存在 | `ls ~/workspace/.venv/bin/python` | 存在 | 必须 |
| D8.02 | venv Python 版本 | `~/workspace/.venv/bin/python --version` | 3.12.x | 必须 |
| D8.03 | 核心包安装 | `~/workspace/.venv/bin/pip list 2>/dev/null \| wc -l` | > 10 | 建议 |

---

## 四、已知差异清单 (KNOWN)

这些差异是刻意的或当前可接受的，不计入 FAIL。

| # | 差异 | 涉及机器 | 原因 | 状态 |
|---|------|---------|------|------|
| K01 | 无 gcloud | Mac Mini | 不管理 GCP，仅作住宅 IP 节点 | 可接受 |
| K02 | 无完整 VPS SSH config | Mac Mini | 远程开发用，VPS 管理走其他机器 | 可接受 |
| K03 | gh token 可能过期 | Mac Mini | SSH URL 仍可用 | WARN 级别 |
| K04 | Python 版本细微差异 | Tokyo VM (3.12.3 系统) vs macOS (3.12.12 pyenv) | 均为 3.12.x | 可接受 |
| K05 | gitleaks 版本差异 | Tokyo VM (8.24.3) vs macOS (8.30.0) | 功能兼容 | 可接受 |
| K06 | 1Password SSH Agent | MacBook Pro 独有 | 个人偏好，已配置 per-host bypass | 需验证 bypass 正常 |
| K07 | ~/clawd/ 目录 | Mac Mini 独有 | OpenClaw 项目，不属于审计范围 | 不要触碰 |

---

## 五、审计执行流程

### 5.1 采集阶段

```
Step 1: 连接验证
  对 4 台机器执行 SSH 连接测试（iMac 为 localhost）

Step 2: 并行采集
  对每台机器执行同一套命令，输出结构化结果
  注意: 并行 SSH 最多 2 个一批（CLAUDE.md 规则）

Step 3: 汇总比较
  将 4 台机器的结果放入同一张表，逐项对比
```

### 5.2 采集命令模板

每台机器执行以下命令集（一次性采集）:

```bash
# === D1: 工具链 ===
python3 --version 2>&1
pyenv --version 2>&1 || echo "NOT_INSTALLED"
node --version 2>&1 || echo "NOT_INSTALLED"
git --version
gh --version 2>&1 | head -1
uv --version 2>&1 || echo "NOT_INSTALLED"
gitleaks version 2>&1 || echo "NOT_INSTALLED"
docker --version 2>&1 || echo "NOT_INSTALLED"
claude --version 2>&1 || echo "NOT_INSTALLED"

# === D2: GitHub 认证 ===
gh auth status 2>&1 | head -5
ssh -o ConnectTimeout=5 -T git@github.com 2>&1 | tail -1

# === D3: gcloud ===
gcloud --version 2>&1 | head -1 || echo "NOT_INSTALLED"
gcloud config get project 2>&1 || echo "NOT_CONFIGURED"

# === D5: 仓库 ===
for repo in bladeai clawforce crypto-backtest quant-backtest quant-lab ntws longxia-market ig-recruit-radar xai-radar claude-memory ai-expert-monitor whisper-vocab; do
  if [ -d ~/workspace/$repo/.git ]; then
    echo "REPO:$repo:EXISTS"
  else
    echo "REPO:$repo:MISSING"
  fi
done

# === D6: git-sync ===
ls ~/workspace/.sync/git-sync.sh 2>/dev/null && echo "SYNC_SCRIPT:EXISTS" || echo "SYNC_SCRIPT:MISSING"
grep -oP '\(([^)]+)\)' ~/workspace/.sync/git-sync.sh 2>/dev/null | tr -d '()' | wc -w  # REPOS 数量

# === D7: 安全 ===
ls ~/workspace/.githooks/pre-commit 2>/dev/null && echo "HOOK:EXISTS" || echo "HOOK:MISSING"
git config --global core.hooksPath 2>/dev/null || echo "HOOKSPATH:NOT_SET"
which gitleaks 2>/dev/null || echo "GITLEAKS:NOT_IN_PATH"
stat -f '%A' ~/.ssh/id_ed25519 2>/dev/null || stat -c '%a' ~/.ssh/id_ed25519 2>/dev/null || echo "SSH_KEY:MISSING"

# === D8: Python venv ===
ls ~/workspace/.venv/bin/python 2>/dev/null && ~/workspace/.venv/bin/python --version || echo "VENV:MISSING"
```

### 5.3 VPS SSH 测试（单独步骤）

VPS SSH 测试需要逐个执行，且可能超时。单独进行:

```bash
for host in hk-panel jp-dmit sg-proxy us-dmit us-gateway; do
  timeout 15 ssh -o ConnectTimeout=10 -o BatchMode=yes $host echo "VPS:$host:OK" 2>/dev/null || echo "VPS:$host:FAIL"
done
```

### 5.4 报告模板

```
# 开发机审计报告 — YYYY-MM-DD

## 总览
| 维度 | iMac | MacBook Pro | Mac Mini | Tokyo VM |
|------|------|-------------|----------|----------|
| D1 工具链 | ✅ | ✅ | ✅ | ⚠️ |
| D2 GitHub | ✅ | ✅ | ⚠️ | ✅ |
| D3 gcloud | ✅ | ✅ | 📌 K01 | ✅ |
| D4 VPS SSH | ✅ | ✅ | 📌 K02 | ✅ |
| D5 仓库 | ✅ | ✅ | ✅ | ✅ |
| D6 git-sync | ✅ | ✅ | ✅ | ✅ |
| D7 安全 | ✅ | ✅ | ✅ | ✅ |
| D8 Python | ✅ | ✅ | ✅ | ✅ |

## FAIL 项 (需修复)
- 无 / 列出每项

## WARN 项 (待观察)
- 列出每项

## KNOWN 差异 (已确认)
- K01: Mac Mini 无 gcloud — 可接受
- ...

## 逐项详情
(D1.01 ~ D8.03 完整结果表)
```

---

## 六、审计频率

| 场景 | 频率 | 说明 |
|------|------|------|
| **常规审计** | 每月 1 次 | 确保 4 台机器未漂移 |
| **新机器接入** | 接入时 1 次 | 新机器必须过审计全项 |
| **大规模变更后** | 变更后立即 | 如添加新仓库、更换 SSH key |
| **工具升级后** | 升级后 | 确认版本一致性 |
| **git-sync 修改后** | 修改后 | 确认 REPOS 列表和安全性 |

---

## 七、修复优先级

| 级别 | 定义 | 响应时间 |
|------|------|---------|
| **P0** | 无法 push/pull 代码 (D2 全 FAIL, D5 仓库缺失) | 立即修复 |
| **P1** | 安全风险 (D7 hook 缺失, 明文密钥) | 当天修复 |
| **P2** | 自动同步失效 (D6 daemon 未运行) | 一周内修复 |
| **P3** | 版本不一致, 工具缺失 | 下次审计前修复 |

---

## 八、框架维护

### 添加新检查项
1. 在对应维度 (D1-D8) 添加检查项
2. 更新采集命令模板
3. 如有新的已知差异，更新第四章

### 添加新机器
1. 在 §1.2 添加机器信息
2. 执行全量审计
3. 记录该机器特有的 KNOWN 差异

### 添加新仓库
1. 更新 D5 仓库列表（当前 12 个）
2. 更新 D6.02 的 REPOS 数量预期
3. 确保所有 4 台机器的 git-sync.sh REPOS 数组同步更新

### 版本历史

| 版本 | 日期 | 修改 |
|------|------|------|
| v1.0 | 2026-02-17 | 初始版本: 8 维度 34 项检查, 7 项已知差异, 基于 4 台机器实际审计经验 |
| v1.1 | 2026-02-16 | +D7.07 hook 使用 gitleaks 检查; 补充 hooksPath 为全局机制, 不逐 repo 复制 |
